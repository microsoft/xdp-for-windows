<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <ProjectReference Include="$(SolutionDir)src\bpfexport\bpfexport.vcxproj">
      <Project>{8f8830ff-1648-4772-87ed-f5da091fc931}</Project>
      <Private>false</Private>
    </ProjectReference>
  </ItemGroup>
  <PropertyGroup>
    <ProjectGuid>{5de7385c-80b3-40cd-97d0-7c24dec2f95c}</ProjectGuid>
    <TargetName>bpf</TargetName>
    <UndockedType>none</UndockedType>
    <ImportEbpf>true</ImportEbpf>
  </PropertyGroup>
  <Import Project="$(SolutionDir)src\xdp.undocked.cpp.props" />
  <PropertyGroup>
    <TargetName>bpf</TargetName>
    <OutDir>$(OutDir)bpf\</OutDir>
  </PropertyGroup>
  <ItemDefinitionGroup>
    <PreBuildEvent>
      <Command>
        xcopy $(EbpfPackagePath)build\native\bin\EbpfApi.dll $(SolutionDir)artifacts\bin\$(Platform)_$(Configuration) /Y
        $(EbpfPackagePath)build\native\bin\export_program_info.exe
        $(SolutionDir)artifacts\bin\$(Platform)_$(Configuration)\xdpbpfexport.exe
      </Command>
    </PreBuildEvent>
    <PostBuildEvent>
      <Command>
        $(SolutionDir)artifacts\bin\$(Platform)_$(Configuration)\xdpbpfexport.exe --clear
        $(EbpfPackagePath)build\native\bin\export_program_info.exe --clear
        del $(SolutionDir)artifacts\bin\$(Platform)_$(Configuration)\ebpfapi.dll /F
      </Command>
    </PostBuildEvent>
  </ItemDefinitionGroup>
  <ItemGroup>
    <CustomBuild Include="allow_ipv6.c">
      <FileType>CppCode</FileType>
      <Outputs>$(OutDir)allow_ipv6.sys</Outputs>
      <Command>
        clang -g -target bpf -O2 -Werror $(ClangIncludes) -c %(Filename).c -o $(OutDir)%(Filename).o
        pushd $(OutDir)
        powershell -NonInteractive -ExecutionPolicy Unrestricted $(EbpfBinPath)\Convert-BpfToNative.ps1 -FileName %(Filename) -IncludeDir $(EbpfIncludePath) -Platform $(Platform) -Configuration $(Configuration) -KernelMode $true
        rmdir /s /q $(OutDir)\allow_ipv6_km
        popd</Command>
    </CustomBuild>
    <CustomBuild Include="drop.c">
      <FileType>CppCode</FileType>
      <Outputs>$(OutDir)drop.sys</Outputs>
      <Command>
        clang -g -target bpf -O2 -Werror $(ClangIncludes) -c %(Filename).c -o $(OutDir)%(Filename).o
        pushd $(OutDir)
        powershell -NonInteractive -ExecutionPolicy Unrestricted $(EbpfBinPath)\Convert-BpfToNative.ps1 -FileName %(Filename) -IncludeDir $(EbpfIncludePath) -Platform $(Platform) -Configuration $(Configuration) -KernelMode $true
        rmdir /s /q $(OutDir)\drop_km
        popd</Command>
    </CustomBuild>
    <CustomBuild Include="selective_drop.c">
      <FileType>CppCode</FileType>
      <Outputs>$(OutDir)selective_drop.sys</Outputs>
      <Command>
        clang -g -target bpf -O2 -Werror $(ClangIncludes) -c %(Filename).c -o $(OutDir)%(Filename).o
        pushd $(OutDir)
        powershell -NonInteractive -ExecutionPolicy Unrestricted $(EbpfBinPath)\Convert-BpfToNative.ps1 -FileName %(Filename) -IncludeDir $(EbpfIncludePath) -Platform $(Platform) -Configuration $(Configuration) -KernelMode $true
        rmdir /s /q $(OutDir)\selective_drop_km
        popd</Command>
    </CustomBuild>
    <CustomBuild Include="l1fwd.c">
      <FileType>CppCode</FileType>
      <Outputs>$(OutDir)l1fwd.sys</Outputs>
      <Command>
        clang -g -target bpf -O2 -Werror $(ClangIncludes) -c %(Filename).c -o $(OutDir)%(Filename).o
        pushd $(OutDir)
        powershell -NonInteractive -ExecutionPolicy Unrestricted $(EbpfBinPath)\Convert-BpfToNative.ps1 -FileName %(Filename) -IncludeDir $(EbpfIncludePath) -Platform $(Platform) -Configuration $(Configuration) -KernelMode $true
        rmdir /s /q $(OutDir)\l1fwd_km
        popd</Command>
    </CustomBuild>
    <CustomBuild Include="pass.c">
      <FileType>CppCode</FileType>
      <Outputs>$(OutDir)pass.sys</Outputs>
      <Command>
        clang -g -target bpf -O2 -Werror $(ClangIncludes) -c %(Filename).c -o $(OutDir)%(Filename).o
        pushd $(OutDir)
        powershell -NonInteractive -ExecutionPolicy Unrestricted $(EbpfBinPath)\Convert-BpfToNative.ps1 -FileName %(Filename) -IncludeDir $(EbpfIncludePath) -Platform $(Platform) -Configuration $(Configuration) -KernelMode $true
        rmdir /s /q $(OutDir)\pass_km
        popd</Command>
    </CustomBuild>
  </ItemGroup>
  <Import Project="$(SolutionDir)src\xdp.undocked.targets" />
</Project>

name: Build XDP Matrix

# The caller is responsible for making sure all options passed to this workflow are valid and compatible with each other.

on:
  workflow_call:
    inputs:
      ref:
        required: false
        default: ''
        type: string
      id:
        required: false
        default: ''
        type: string
      codeql:
        required: false
        default: true
        type: boolean
  workflow_dispatch:
    inputs:
      ref:
        required: false
        default: ''
        type: string
        description: 'The git commit hash (or HEAD of current branch if left empty) of XDP to build.'
      id:
        required: false
        default: ''
        type: string
        description: 'With multiple builds with duplicate configurations (e.g. Debug_x64_2022), you can append an ID (e.g. Debug_x64_2022_myid).'

jobs:
  test-job1:
    name: Fail this job
    runs-on: ubuntu-latest
    steps:
      - name: Print ref
        run: echo ${{ github.ref }}
      - name: Should fail
        run: exit 1

  test-job2:
    name: Pass this job
    runs-on: ubuntu-latest
    steps:
      - name: Print ref
        run: echo ${{ github.ref }}
      - name: Should pass
        run: exit 0

  Release_Branch_Requirements:
    name: Release Branch Requirements
    if: always()
    needs: [test-job1, test-job2]
    runs-on: ubuntu-latest
    permissions: {} # No need for any permissions.
    steps:
    - name: Decide whether the needed jobs succeeded or failed
      if: ${{ startsWith(github.ref, 'refs/heads/release/') }}
      uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe
      with:
        jobs: ${{ toJSON(needs) }}

  Non_Release_Branch_Requirements:
    name: Non Release Branch Requirements
    if: always()
    needs: [test-job1, test-job2]
    runs-on: ubuntu-latest
    permissions: {} # No need for any permissions.
    steps:
    - name: Decide whether the needed jobs succeeded or failed
      if: ${{ !startsWith(github.ref, 'refs/heads/release/') }}
      uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe
      with:
        jobs: ${{ toJSON(needs) }}

  Complete:
    name: Complete
    if: always()
    needs: [Release_Branch_Requirements, Non_Release_Branch_Requirements]
    runs-on: ubuntu-latest
    permissions: {} # No need for any permissions.
    steps:
    - name: Decide whether the needed jobs succeeded or failed
      uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe
      with:
        jobs: ${{ toJSON(needs) }}

name: Build XDP

# The caller is responsible for making sure all options passed to this workflow are valid and compatible with each other.

on:
  workflow_call:
    inputs:
      ref:
        required: false
        default: ''
        type: string
      config:
        required: false
        default: 'Release'
        type: string
        # options:
        #   - Debug
        #   - Release
      os:
        required: false
        type: string
        default: '2022'
        # options:
        #   - 2019
        #   - 2022
      platform:
        required: false
        default: 'x64'
        type: string
        # options:
        #   - x64
      codeql:
        required: false
        default: false
        type: boolean
      upload_artifacts:
        required: false
        default: true
        type: boolean

jobs:
  build:
    name: Build
    strategy:
      fail-fast: false
    runs-on: windows-${{ inputs.os }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@d632683dd7b4114ad314bca15554477dd762a938
      with:
        repository: microsoft/xdp-for-windows
        submodules: recursive
        ref: ${{ inputs.ref }}
    - name: Initialize CodeQL
      if: inputs.codeql
      uses: github/codeql-action/init@v3
      with:
        languages: c-cpp
    - name: Setup MSBuild.exe
      uses: microsoft/setup-msbuild@6fb02220983dee41ce7ae257b6f4d8f9bf5ed4ce
    - name: Prepare Machine
      shell: PowerShell
      run: tools/prepare-machine.ps1 -ForBuild -Verbose -Platform ${{ inputs.platform }}
    - name: Nuget Restore
      run: msbuild.exe xdp.sln /t:restore /p:RestoreConfigFile=src/nuget.config /p:Configuration=${{ inputs.config }} /p:Platform=${{ inputs.platform }}
    - name: Prepare for compiling eBPF programs
      run: tools/prepare-machine.ps1 -ForEbpfBuild -Verbose -Platform ${{ inputs.platform }}
    - name: Build
      run: msbuild xdp.sln /m /p:configuration=${{ inputs.config }} /p:platform=${{ inputs.platform }} /p:SignMode=TestSign /p:IsAdmin=true
    - name: Upload Artifacts
      if: inputs.upload_artifacts
      uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874
      with:
        name: bin_${{ inputs.config }}_${{ inputs.platform }}
        path: |
          artifacts/bin
          !artifacts/bin/**/*.ilk
          !artifacts/bin/**/*.exp
          !artifacts/bin/**/*.lastcodeanalysissucceeded
    - name: Perform CodeQL Analysis
      if: inputs.codeql
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:c-cpp"

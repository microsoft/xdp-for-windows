<?xml version="1.0" encoding="utf-8"?>
<!--
Copyright (c) Microsoft Corporation
SPDX-License-Identifier: MIT
-->
<?define ProductVersion="{9363C0E3-4DE9-4067-9F5E-6A1A06034B59}"?>
<?define UpgradeCode="{79F93392-843E-4B85-824B-2CFC7D16F080}"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:ui="http://schemas.microsoft.com/wix/UIExtension" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
	<Product Id="$(var.ProductVersion)" Name="XDP for Windows" Language="1033" Version="0.16.9" Manufacturer="Microsoft" UpgradeCode="$(var.UpgradeCode)">
		<Package Description="XDP for Windows" InstallerVersion="301" Compressed="yes" InstallScope="perMachine" Manufacturer="Microsoft" Platform="x64" />
		<MajorUpgrade AllowSameVersionUpgrades="yes"
					  Disallow="yes" DisallowUpgradeErrorMessage="An older version of [ProductName] is already installed. Please remove it first."
					  AllowDowngrades="no" DowngradeErrorMessage="A newer version of [ProductName] is already installed. Please remove it first." Schedule="afterInstallFinalize" />
		<MediaTemplate EmbedCab="yes" />

		<!-- Define global properties -->
		<PropertyRef Id="WIX_ACCOUNT_LOCALSERVICE" />
		<Property Id="ARPCONTACT" Value="opencode@microsoft.com" />
		<Property Id="TARGETDIR" Secure="yes">
			<RegistrySearch Id="FindInstallLocation" Root="HKLM" Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\[WIX_UPGRADE_DETECTED]" Name="InstallLocation" Type="raw" Win64="yes" />
		</Property>

		<!-- Define the Product features and installation steps -->
		<Feature Id="ProductFeature" Title="XDP for Windows Installer" ConfigurableDirectory="TARGETDIR" Display="expand" Level="1" Absent="disallow" AllowAdvertise="no" InstallDefault="local" TypicalDefault="install" >
			<Feature Id="xdp_Runtime_Components" Level="1" Title="Runtime Components" Absent="disallow" Display="expand" AllowAdvertise="no" >
				<ComponentGroupRef Id="xdpapi_dll" />
				<ComponentGroupRef Id="xdp_driver" />
			</Feature>
		</Feature>

		<InstallExecuteSequence>
			<!--Rollback sequence-->
			<Custom Action="xdpInf_uninstall_rollback" Before="xdpInf_install">NOT Installed</Custom>
			<Custom Action="xdp_driver_stop_rollback" Before="xdp_driver_install">NOT Installed</Custom>
			<Custom Action="xdp_driver_uninstall_rollback" Before="xdp_driver_install">NOT Installed</Custom>

			<!--Install sequence-->
			<Custom Action="xdpInf_install" After="InstallFiles">NOT Installed</Custom>
			<Custom Action="xdp_driver_install" After="InstallFiles">NOT Installed</Custom>
			<Custom Action="xdp_driver_start" After="xdp_driver_install">NOT Installed</Custom>

			<!--Uninstall sequence-->
			<Custom Action="xdpInf_uninstall" After="InstallInitialize">REMOVE="ALL"</Custom>
			<Custom Action="xdp_driver_stop" After="InstallInitialize">REMOVE="ALL"</Custom>
			<Custom Action="xdp_driver_uninstall" After="xdp_driver_stop">REMOVE="ALL"</Custom>			
			<Custom Action="xdp_driver_uninstall_flush" After="InstallFinalize">REMOVE="ALL"</Custom>
		</InstallExecuteSequence>

		<!-- Define the UI style & behavior -->
		<CustomAction Id="SetWixInstallLocation" Property="ARPINSTALLLOCATION" Value="[TARGETDIR]" />
		<InstallUISequence>
			<Custom Action="SetWixInstallLocation" After="CostFinalize" />
		</InstallUISequence>
		<UI />
	</Product>

	<!-- Define installation directories -->
	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="SystemFolder" Name="SystemFolder">
				<Directory Id="dir_drivers" Name="drivers"/>
			</Directory>
		</Directory>
	</Fragment>

	<!-- Define the product's <Runtime> components -->
	<Fragment>		
		<!--Install/Uninstall the WinPE in xdp.inf-->
		<!--NOTE: qtexec does not currently support a working directory (ref. https://github.com/wixtoolset/issues/issues/1265)-->
		<!--      This workaround uses PowerShell to batch two commands, one to change the working directory, the other to execute the actual command from that directory.-->
		<SetProperty Id="xdpInf_install" Value="&quot;[WindowsFolder]System32\WindowsPowerShell\v1.0\powershell.exe&quot; -ExecutionPolicy Bypass &quot;cd '[dir_drivers]';netcfg.exe -v -l xdp.inf -c s -i ms_xdp&quot;" Before="xdpInf_install" Sequence="execute"/>
		<CustomAction Id="xdpInf_install" BinaryKey="WixCA" DllEntry="WixQuietExec64" Execute="deferred" Return="check" Impersonate="no"/>
		<SetProperty Id="xdpInf_uninstall" Value="&quot;[WindowsFolder]System32\WindowsPowerShell\v1.0\powershell.exe&quot; -ExecutionPolicy Bypass &quot;cd '[dir_drivers]';netcfg.exe -u ms_xdp&quot;" Before="xdpInf_uninstall" Sequence="execute"/>
		<CustomAction Id="xdpInf_uninstall" BinaryKey="WixCA" DllEntry="WixQuietExec64" Execute="deferred" Return="ignore" Impersonate="no"/>
		<SetProperty Id="xdpInf_uninstall_rollback" Value="&quot;[WindowsFolder]System32\WindowsPowerShell\v1.0\powershell.exe&quot; -ExecutionPolicy Bypass &quot;cd '[dir_drivers]';netcfg.exe -u ms_xdp&quot;" Before="xdpInf_uninstall_rollback" Sequence="execute"/>
		<CustomAction Id="xdpInf_uninstall_rollback" BinaryKey="WixCA" DllEntry="WixQuietExec64" Execute="deferred" Return="ignore" Impersonate="no"/>

		<!--Install/Uninstall the XDP Driver & DLL-->
		<!--A kernel driver service is not currently supported by the Windows Installer (Wix v3 - https://wixtoolset.org/docs/v3/xsd/wix/serviceinstall/).-->
		<ComponentGroup Id="xdpapi_dll" Directory="SystemFolder">
			<Component Id="xdpapi.dll" Guid="{18A0B4FC-9F22-4E15-8AD2-64131E6E238B}">
				<File Id="xdpapi.dll" Name="xdpapi.dll" Source="$(var.xdpapi.TargetDir)xdpapi.dll" KeyPath="yes" />
			</Component>
			<Component Id="xdpapi.pdb" Guid="{12CB0C1D-F93D-4A4D-BEAC-4FEE589C7192}">
				<File Id="xdpapi.pdb" Name="xdpapi.pdb" Source="$(var.xdpapi.TargetDir)xdpapi.pdb" KeyPath="yes" />
			</Component>
		</ComponentGroup>
		<ComponentGroup Id="xdp_driver" Directory="dir_drivers">			
			<Component Id="xdp.inf" Guid="{70A53BC2-8D56-4D53-B8FA-F07EC3D4783A}">
				<File Id="xdp.inf" Name="xdp.inf" Source="$(var.xdp.TargetDir)xdp.inf" KeyPath="yes"/>
			</Component>
			<Component Id="xdp.sys" Guid="{5E1B9729-E58D-4A4D-A845-FB6D2EE0C498}">
				<File Id="xdp.sys" Name="xdp.sys" Source="$(var.xdp.TargetPath)" KeyPath="yes" />
			</Component>
			<Component Id="xdp.pdb" Guid="{BC5C7A2C-613B-4831-A721-1FDFC4129F12}">
				<File Id="xdp.pdb" Name="xdp.pdb" Source="$(var.xdp.TargetDir)xdp.pdb" KeyPath="yes" />
			</Component>
		</ComponentGroup>
		<SetProperty Id="xdp_driver_install" Value='"sc.exe" create xdp type=kernel start=auto binpath="[#xdp.sys]"' Before="xdp_driver_install" Sequence="execute"/>
		<CustomAction Id="xdp_driver_install" BinaryKey="WixCA" DllEntry="WixQuietExec64" Execute="deferred" Return="check" Impersonate="no"/>
		<Property Id="xdp_driver_start" Value='"net.exe" start xdp' />
		<CustomAction Id="xdp_driver_start" BinaryKey="WixCA" DllEntry="WixQuietExec64" Execute="deferred" Return="check" Impersonate="no"/>
		<Property Id="xdp_driver_stop" Value='"net.exe" stop xdp' />
		<CustomAction Id="xdp_driver_stop" BinaryKey="WixCA" DllEntry="WixQuietExec64" Execute="deferred" Return="ignore" Impersonate="no"/>
		<Property Id="xdp_driver_uninstall" Value='"sc.exe" delete xdp' />
		<CustomAction Id="xdp_driver_uninstall" BinaryKey="WixCA" DllEntry="WixQuietExec64" Execute="deferred" Return="ignore" Impersonate="no"/>
		<CustomAction Id="xdp_driver_uninstall_flush" Directory="TARGETDIR" ExeCommand ='"sc.exe" query xdp' Execute ="immediate" Return ="asyncNoWait"/>
		<Property Id="xdp_driver_stop_rollback" Value='"net.exe" stop xdp' />
		<CustomAction Id="xdp_driver_stop_rollback" BinaryKey="WixCA" DllEntry="WixQuietExec64" Execute="rollback" Return="ignore" Impersonate="no"/>
		<Property Id="xdp_driver_uninstall_rollback" Value='"sc.exe" delete xdp' />
		<CustomAction Id="xdp_driver_uninstall_rollback" BinaryKey="WixCA" DllEntry="WixQuietExec64" Execute="rollback" Return="ignore" Impersonate="no"/>
	</Fragment>
</Wix>
